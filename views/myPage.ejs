<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"
    />
    <title>Document</title>
  </head>
  <body>
    <%- include("../components/TopNav.html") %>

    <div class="container py-5">
      <div class="card col-5 mx-auto">
        <div class="card-body text-center">
          <div
            class="position-relative rounded-circle mb-3 mx-auto"
            style="width: 150px; height: 150px"
          >
            <img
              id="profile-preview"
              src="<%= user.profileImage %>"
              class="rounded-circle <%= user.profileImage ? '' : 'd-none' %>"
              width="100%"
              data-original="<%= user.profileImage || ''%>"
              style="display: block"
            />
            <svg
              id="profile-default"
              xmlns="http://www.w3.org/2000/svg"
              width="100%"
              height="100%"
              class="<%= user.profileImage ? 'd-none' : '' %>"
              style="display: block"
              viewBox="0 0 496 512"
            >
              <style>
                svg {
                  fill: #c0c0c0;
                }
              </style>
              <path
                d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"
              />
            </svg>
            <label
              for="input-profile"
              class="position-absolute btn btn-link text-decoration-none fa fa-edit p-0"
              style="top: 0; right: -10%"
            >
            </label>
          </div>
          <form
            id="form-profile"
            action="<%= `/api/user/${user._id}?_method=PATCH` %>"
            method="POST"
            enctype="multipart/form-data"
          >
            <input
              id="input-profile"
              type="file"
              class="form-control-file"
              accept="image/*"
              hidden
              name="profileImage"
            />
            <div class="form-group">
              <input
                class="h4 text-center border-0 w-50"
                style="
                  border-bottom: 1px solid lightgray !important;
                  outline: none;
                "
                value="<%= user.name || user.id %>"
                placeholder="Name"
                required
                name="name"
              />
            </div>
            <button type="submit" class="btn btn-success w-50">Apply</button>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script>
      const preview = $("img#profile-preview");
      const defaultImg = $("svg#profile-default");
      const imageInput = $("input#input-profile");

      preview.on("load", () => {
        preview.removeClass("d-none");
        defaultImg.addClass("d-none");
      });
      preview.on("error", () => {
        preview.addClass("d-none");
        defaultImg.removeClass("d-none");
      });

      imageInput.change((e) => {
        const image = e.target.files[0];
        if (!image) return;

        const reader = new FileReader();
        reader.onerror = invalidFile;
        reader.onloadend = () => {
          if (reader.result == "data:") return invalidFile();

          preview.attr("src", reader.result);
        };

        reader.readAsDataURL(image);
      });

      function invalidFile() {
        alert("Failed to load image.");
        imageInput.val(null);
        preview.attr("src", preview.data("original"));
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
